<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>常総コミュニティ防災プラットフォーム</title>
    <style>
        #map { height: 600px; width: 100%; border: 2px solid #333; margin-bottom: 20px; }
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; background-color: #f9f9f9; }
        #post-text { width: 100%; height: 80px; margin-bottom: 10px; box-sizing: border-box; padding: 10px; }
        #emergency-categories { display: none; gap: 10px; margin-bottom: 15px; padding: 10px; background-color: #ffe0e0; border-radius: 5px; }
        #emergency-categories label { padding: 8px 12px; border: 1px solid #ff4444; background: white; border-radius: 5px; cursor: pointer; color: #d32f2f; font-weight: bold; }
        button { cursor: pointer; background: #333; color: white; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="map"></div>
    <button id="mode-toggle" style="margin-bottom: 15px;">非常時モードに切り替え</button>

    <form id="post-form">
        <textarea id="post-text" placeholder="状況をつぶやいてください..."></textarea>
        <div id="emergency-categories">
            <label><input type="radio" name="category" value="被害無し"> 被害無し</label>
            <label><input type="radio" name="category" value="被害あり"> 被害あり</label>
            <label><input type="radio" name="category" value="支援要請"> 支援要請</label>
        </div>
        <button type="submit" style="width: 100%; background: #007bff;">投稿（位置情報必須）</button>
    </form>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // Firebase初期化 (HTML内に直接書くことで ReferenceError を防ぎます)
        const firebaseConfig = {
            apiKey: "AIzaSyBMOr6Kag-PCGL6piRVtjCDukk01aurb1M",
            authDomain: "joso-13c95.firebaseapp.com",
            projectId: "joso-13c95",
            storageBucket: "joso-13c95.firebasestorage.app",
            messagingSenderId: "659788884587",
            appId: "1:659788884587:web:39b9a1b840039c24875f2e"
        };
        
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        let map;
        let isEmergencyMode = false;
        let markers = [];

        // 地図の初期化
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 14,
                center: { lat: 35.9897, lng: 139.9791 }
            });
            loadPosts(); // 地図ができたら投稿を読み込む
        }

        // 表示件数4個制限 & まとめて表示する関数
        function loadPosts() {
            markers.forEach(m => m.setMap(null));
            markers = [];

            db.collection('posts')
                .orderBy('timestamp', 'desc')
                .limit(50)
                .get()
                .then(snapshot => {
                    const groupedPosts = {};
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const posKey = `${data.lat}_${data.lng}`;
                        
                        if (!groupedPosts[posKey]) {
                            groupedPosts[posKey] = { lat: data.lat, lng: data.lng, mode: data.mode, contents: [] };
                        }
                        // 同じ場所に最大4件まで
                        if (groupedPosts[posKey].contents.length < 4) {
                            groupedPosts[posKey].contents.push({
                                text: data.text,
                                category: data.category || "通常",
                                time: data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString() : ''
                            });
                        }
                    });

                    Object.values(groupedPosts).forEach(group => {
                        const marker = new google.maps.Marker({
                            position: { lat: group.lat, lng: group.lng },
                            map: map,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                fillColor: group.mode === 'emergency' ? 'red' : 'blue',
                                fillOpacity: 0.8, scale: 10, strokeColor: 'white', strokeWeight: 2
                            }
                        });

                        const html = group.contents.map(c => 
                            `<div style="border-bottom:1px solid #eee; padding:5px; color:black;">
                                <b>[${c.category}]</b> <small>${c.time}</small><br>${c.text}
                            </div>`
                        ).join('');

                        const infoWindow = new google.maps.InfoWindow({ content: `<div style="min-width:180px">${html}</div>` });
                        marker.addListener('click', () => infoWindow.open(map, marker));
                        markers.push(marker);
                    });
                    console.log("再読み込み完了！現在の表示地点数:", Object.keys(groupedPosts).length);
                }).catch(err => {
                    console.error("読み込み失敗:", err);
                });
        }

        // 投稿の保存
        document.getElementById('post-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const text = document.getElementById('post-text').value;
            if (!text.trim()) return;

            navigator.geolocation.getCurrentPosition((pos) => {
                const lat = Math.round(pos.coords.latitude * 1000) / 1000;
                const lng = Math.round(pos.coords.longitude * 1000) / 1000;
                const categoryEl = document.querySelector('input[name="category"]:checked');
                const category = isEmergencyMode && categoryEl ? categoryEl.value : "通常";

                db.collection('posts').add({
                    text: text, lat: lat, lng: lng, category: category,
                    mode: isEmergencyMode ? 'emergency' : 'normal',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    alert("投稿しました！");
                    document.getElementById('post-text').value = '';
                    loadPosts();
                }).catch(err => {
                    console.error("保存失敗:", err);
                    alert("エラー：コンソール(F12)を確認して、リンクがあればクリックしてインデックスを作成してください。");
                });
            }, () => alert("位置情報をオンにしてください"));
        });

        // モード切替
        document.getElementById('mode-toggle').addEventListener('click', () => {
            isEmergencyMode = !isEmergencyMode;
            document.getElementById('mode-toggle').textContent = isEmergencyMode ? '通常モードに戻す' : '非常時モードに切り替え';
            document.getElementById('emergency-categories').style.display = isEmergencyMode ? 'flex' : 'none';
            document.body.style.backgroundColor = isEmergencyMode ? '#fff0f0' : '#f9f9f9';
        });
    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB7hvh-OUCTVM62geqN543IMtgEWl-eeTQ&callback=initMap"></script>

</body>
</html>
