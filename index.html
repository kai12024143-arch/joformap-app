<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>常総コミュニティ防災プラットフォーム</title>
    <style>
        #map { height: 600px; width: 100%; border: 2px solid #333; margin-bottom: 20px; }
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; background-color: #f9f9f9; }
        #post-text { width: 100%; height: 80px; margin-bottom: 10px; box-sizing: border-box; padding: 10px; }
        #emergency-categories { display: none; gap: 10px; margin-bottom: 15px; padding: 10px; background-color: #ffe0e0; border-radius: 5px; }
        #emergency-categories label { padding: 8px 12px; border: 1px solid #ff4444; background: white; border-radius: 5px; cursor: pointer; color: #d32f2f; font-weight: bold; }
        button { cursor: pointer; background: #333; color: white; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="map"></div>
    <button id="mode-toggle" style="margin-bottom: 15px;">非常時モードに切り替え</button>

    <form id="post-form">
        <textarea id="post-text" placeholder="状況をつぶやいてください..."></textarea>
        <div id="emergency-categories">
            <label><input type="radio" name="category" value="被害無し"> 被害無し</label>
            <label><input type="radio" name="category" value="被害あり"> 被害あり</label>
            <label><input type="radio" name="category" value="支援要請"> 支援要請</label>
        </div>
        <button type="submit" style="width: 100%; background: #007bff;">投稿（位置情報必須）</button>
    </form>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>  
      // --- ここから入れ替え ---
const firebaseConfig = {
    apiKey: "AIzaSyBMOr6Kag-PCGL6piRVtjCDukk01aurb1M",
    authDomain: "joso-13c95.firebaseapp.com",
    projectId: "joso-13c95",
    storageBucket: "joso-13c95.firebasestorage.app",
    messagingSenderId: "659788884587",
    appId: "1:659788884587:web:39b9a1b840039c24875f2e"
};

if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const db = firebase.firestore();

let map;
let isEmergencyMode = false;
let markers = [];

function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 14,
        center: { lat: 35.9897, lng: 139.9791 }
    });
    loadPosts();
}

async function loadPosts() {
    console.log("読み込み開始...");
    markers.forEach(m => m.setMap(null));
    markers = [];

    try {
        const snapshot = await db.collection('posts')
            .orderBy('timestamp', 'desc')
            .limit(50)
            .get();

        if (snapshot.empty) return;

        const groupedPosts = {};
        const bounds = new google.maps.LatLngBounds();

        snapshot.forEach(doc => {
            const data = doc.data();
            if (!data.lat || !data.lng) return;

            const posKey = `${data.lat.toFixed(3)}_${data.lng.toFixed(3)}`;
            if (!groupedPosts[posKey]) {
                groupedPosts[posKey] = { lat: data.lat, lng: data.lng, mode: data.mode, contents: [] };
            }
            if (groupedPosts[posKey].contents.length < 4) {
                groupedPosts[posKey].contents.push({
                    text: data.text || "内容なし",
                    category: data.category || "通常",
                    time: data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString() : '不明'
                });
            }
            bounds.extend({ lat: data.lat, lng: data.lng });
        });

        Object.values(groupedPosts).forEach(group => {
            const marker = new google.maps.Marker({
                position: { lat: group.lat, lng: group.lng },
                map: map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: group.mode === 'emergency' ? '#FF0000' : '#0000FF',
                    fillOpacity: 0.8, scale: 12, strokeColor: 'white', strokeWeight: 2
                },
                animation: google.maps.Animation.DROP // 落ちてくるアニメで存在をアピール
            });

            const html = group.contents.map(c => 
                `<div style="border-bottom:1px solid #ccc; padding:8px; color:black !important;">
                    <b style="color:red;">[${c.category}]</b> <small style="color:#666;">${c.time}</small><br>
                    <div style="margin-top:4px; font-weight:bold; color:black;">${c.text}</div>
                </div>`
            ).join('');

            const infoWindow = new google.maps.InfoWindow({
                content: `<div style="padding:10px; max-width:220px; background:white;">${html}</div>`
            });

            marker.addListener('click', () => infoWindow.open(map, marker));
            markers.push(marker);
        });

        // 投稿がある場所に強制的に移動！
        map.fitBounds(bounds);
        console.log("ついに表示成功！");

    } catch (err) {
        console.error("エラー:", err);
        setTimeout(loadPosts, 3000); // 失敗しても3秒後に自動リトライ
    }
}

// 投稿ボタンの設定
document.getElementById('post-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const text = document.getElementById('post-text').value;
    if (!text.trim()) return;

    navigator.geolocation.getCurrentPosition((pos) => {
        const lat = Math.round(pos.coords.latitude * 1000) / 1000;
        const lng = Math.round(pos.coords.longitude * 1000) / 1000;
        const cat = isEmergencyMode ? document.querySelector('input[name="category"]:checked')?.value : "通常";

        db.collection('posts').add({
            text: text, lat: lat, lng: lng, category: cat || "通常",
            mode: isEmergencyMode ? 'emergency' : 'normal',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            alert("投稿成功！");
            document.getElementById('post-text').value = '';
            loadPosts();
        }).catch(err => alert("エラー！F12のリンクをクリックしてください"));
    });
});

// モード切替
document.getElementById('mode-toggle').addEventListener('click', () => {
    isEmergencyMode = !isEmergencyMode;
    document.getElementById('mode-toggle').textContent = isEmergencyMode ? '通常モードに戻す' : '非常時モードに切り替え';
    document.getElementById('emergency-categories').style.display = isEmergencyMode ? 'flex' : 'none';
    document.body.style.backgroundColor = isEmergencyMode ? '#fff0f0' : '#f9f9f9';
});
